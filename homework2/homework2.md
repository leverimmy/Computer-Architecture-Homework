# 第 2 次作业

## 第 1 题（教材 7.8）

> 假设对指令 Cache 的访问占全部访问的 $75\%$；而对数据 Cache 的访问占全部访问的 $25\%$。Cache 的命中时间为一个时钟周期，不命中开销为 $50$ 个时钟周期，在混合 Cache 中一次 `load` 或 `store` 操作访问 Cache 的命中时间都要增加一个时钟周期，$32\;\mathrm{KB}$ 的指令 Cache 的不命中率为 $0.39\%$，$32\;\mathrm{KB}$ 的数据 Cache 的不命中率为 $4.82\%$，$64\;\mathrm{KB}$ 的混合 Cache 的不命中率为 $1.35\%$。又假设采用写直达策略，且有一个写缓冲器，并且忽略写缓冲器引起的等待。试问指令 Cache 和数据 Cache 容量均为 $32\;\mathrm{KB}$ 的分离 Cache 和容量为 $64\;\mathrm{KB}$ 的混合 Cache 相比，哪种 Cache 的不命中率更低？两种情况下平均访存时间各是多少？

指令 Cache 和数据 Cache 容量均为 $32\;\mathrm{KB}$ 的分离 Cache 的不命中率为：

$$
75\% \times 0.39\% + 25\% \times 4.82\% = 1.4975\%
$$

由于 $1.4975\% > 1.35\%$，因此，容量为 $64\;\mathrm{KB}$ 的混合 Cache 不命中率更低。

指令 Cache 和数据 Cache 容量均为 $32\;\mathrm{KB}$ 的分离 Cache 的平均访存时间（单位：时钟周期数）为：

$$
75\% \times (1 + 0.39\% \times 50) + 25\% \times (1 + 4.82\% \times 50) = 1.74875
$$

容量为 $64\;\mathrm{KB}$ 的混合 Cache 的平均访存时间（单位：时钟周期数）为：

$$
2 + 1.35\% \times 50 = 2.675
$$

## 第 2 题（教材 7.11）

> 在伪相联中，假设在直接映像位置没有发现匹配，而在另一个位置才找到数据（伪命中）时，不对这两个位置的数据进行交换。这时只需要一个额外的周期。假设不命中开销为 $50$ 个时钟周期，$2\;\mathrm{KB}$ 直接映像 Cache 的不命中率为 $9.8\%$，两路组相联的不命中率为 $7.6\%$；$128\;\mathrm{KB}$ 直接映像 Cache 的不命中率为 $1.0\%$，两路组相联的不命中率为 $0.7\%$。
>
> (1) 推导出平均访存时间的公式。
>
> (2) 利用 (1) 中得到的公式，对于 $2\;\mathrm{KB}$ Cache 和 $128\;\mathrm{KB}$ Cache，计算伪相联的平均访存时间。

(1) 由于伪命中时不对数据进行交换，故伪相联中的一对数据，可以看作是两路组相联一组中的两个数据，**此时伪相联的不命中率等于两路组相联的不命中率**。

设一次即命中的命中率为 $H_1$，伪相联的整体命中率为 $H_2$，则需要第二次才命中的概率为 $H_2 - H_1$。平均访存时间（单位：时钟周期数）的公式如下：

$$
\begin{align*}
    \text{平均访存时间}_{\text{伪相联}} & = H_1 \times t_1 + (H_2 - H_1) \times t_2 + (1 - H_2) \times t_3 \\
    & = H_1 \times t_1 + (H_2 - H_1) \times (t_1 + 1) + (1 - H_2) \times (t_1 + 50) \\
    & = t_1 + (H_2 - H_1) + (1 - H_2) \times 50 \\
    & = 1 + (H_2 - H_1) + (1 - H_2) \times 50
\end{align*}
$$

其中 $t_1 = 1$ 是一次即命中所花时间，$t_2 = t_1 + 1$ 为第二次才命中所花时间，$t_3 = t_1 + 50$ 是伪相联未命中所花时间。由题知，$H_1$ 是直接映像 Cache 的命中率，$H_2$ 是两路组相联 Cache 的命中率。

(2) 代入 $2\;\mathrm{KB}$ Cache 的数据，

$$
H_1 = 1 - 9.8\% = 90.2\%, \quad H_2 = 1 - 7.6\% = 92.4\%,
$$

则 $2\;\mathrm{KB}$ Cache 伪相联的平均访存时间（单位：时钟周期数）为

$$
\begin{align*}
    \text{平均访存时间}_{\text{伪相联}, 2\;\mathrm{KB}} = 1 + (92.4\% - 90.2\%) + (1 - 92.4\%) \times 50 = 4.822
\end{align*}
$$

代入 $128\;\mathrm{KB}$ Cache 的数据，

$$
H_1 = 1 - 1.0\% = 99.0\%, \quad H_2 = 1 - 0.7\% = 99.3\%,
$$

则 $128\;\mathrm{KB}$ Cache 伪相联的平均访存时间（单位：时钟周期数）为

$$
\begin{align*}
    \text{平均访存时间}_{\text{伪相联}, 128\;\mathrm{KB}} = 1 + (99.3\% - 99.0\%) + (1 - 99.3\%) \times 50 = 1.353
\end{align*}
$$

## 第 3 题（教材 7.12）

> 假设采用理想存储器系统时的基本 CPI 是 $1.5$，主存延迟是 $40$ 个时钟周期；传输速率为 $4$ 字节/时钟周期，且 Cache 中 $50\%$ 的块是修改过的。每个块中有 $32$ 字节，$20\%$ 的指令是数据传送指令，并假设没有写缓存，在 TLB 不命中的情况下需要 $20$ 个时钟周期，TLB 不会降低 Cache 命中率。CPU 产生指令地址或 Cache 不命中时产生的地址有 $0.2\%$ 没有在 TLB 中找到。
>
> (1) 在理想 TLB 情况下，计算均采用写回法 $16\;\mathrm{KB}$ 直接映像混合 Cache、$16\;\mathrm{KB}$ 两路组相联混合 Cache 和 $32\;\mathrm{KB}$ 直接映像混合 Cache 机器的实际 CPI。
>
> (2) 在实际 TLB 情况下，用 (1) 的结果，计算均采用写回法 $16\;\mathrm{KB}$ 直接映像混合 Cache、$16\;\mathrm{KB}$ 两路组相联混合 Cache 和 $32\;\mathrm{KB}$ 直接映像混合 Cache 机器的实际 CPI。
>
> 其中假设 $16\;\mathrm{KB}$ 直接映像混合 Cache、$16\;\mathrm{KB}$ 两路组相联混合 Cache 和 $32\;\mathrm{KB}$ 直接映像混合 Cache 的不命中率分别为 $2.9\%$、$2.2\%$ 和 $2.0\%$；$25\%$ 的访存为写访问。

平均每条指令的访存次数为

$$
80\% \times 1 + 20\% \times 2 = 1.2
$$

(1) 设 Cache 的不命中率为 $F$。

1. 对于写操作（占 $20\% \times 25\% = 5\%$）：
    1. 如果被替换的块已被修改，则需要将其写回主存（开销为 $40 + 32 / 4 = 48$ 个时钟周期），然后从主存将新的块写入 Cache（开销为 $40 + 32 / 4 = 48$ 个时钟周期）。
    2. 如果未被修改，则需要按写分配，从主存将新的块写入 Cache（开销为 $40 + 32 / 4 = 48$ 个时钟周期），再对 Cache 中的值进行修改。
2. 对于读操作（占 $20\% \times (1 - 25\%) = 15\%$）：
    1. 如果被替换的块已被修改，则需要将其写回主存（开销为 $40 + 32 / 4 = 48$ 个时钟周期），然后从主存将新的块写入 Cache（开销为 $40 + 32 / 4 = 48$ 个时钟周期）。
    2. 如果未被修改，则只需从主存将新的块写入 Cache（开销为 $40 + 32 / 4 = 48$ 个时钟周期）。
3. 对于其他指令（占 $80\%$），处理方式与读操作相同。

综上所述，额外开销（单位：时钟周期数）为 $48 + 50\% \times 48 = 72$。

因此，实际 CPI 为

$$
1.5 + 1.2 \times F \times 72 = 1.5 + 86.4F
$$

代入题目所给数值，得：

1. 对于 $16\;\mathrm{KB}$ 直接映像混合 Cache，$F = 2.9\%$，实际 CPI 为：
$$
1.5 + 86.4 \times 2.9\% = 4.0056
$$
2. 对于 $16\;\mathrm{KB}$ 两路组相联混合 Cache，$F = 2.2\%$，实际 CPI 为：
$$
1.5 + 86.4 \times 2.2\% = 3.4008
$$
3. 对于 $32\;\mathrm{KB}$ 直接映像混合 Cache，$F = 2.0\%$，实际 CPI 为：
$$
1.5 + 86.4 \times 2.0\% = 3.228
$$

(2) 设 Cache 的不命中率为 $F$。每次不命中时，如果 Cache 中被替换的是已被修改过的内容，则需要额外再产生一个地址。因此，CPU 产生指令地址或 Cache 不命中时产生的地址的个数为

$$
1.2 \times (1 + 50\% \times F) = 1.2 + 0.6F
$$

而这些地址有 $0.2\%$ 没有在 TLB 中找到，故额外开销为（单位：时钟周期数）

$$
(1.2 + 0.6F) \times 0.2\% \times 20 = 0.048 + 0.024F
$$

因此，实际 CPI 为

$$
1.5 + 86.4F + 0.048 + 0.024F = 1.548 + 86.424F
$$

代入题目所给数值，得：

1. 对于 $16\;\mathrm{KB}$ 直接映像混合 Cache，$F = 2.9\%$，实际 CPI 为：
$$
1.548 + 86.424 \times 2.9\% = 4.054296
$$
2. 对于 $16\;\mathrm{KB}$ 两路组相联混合 Cache，$F = 2.2\%$，实际 CPI 为：
$$
1.548 + 86.424 \times 2.2\% = 3.449328
$$
3. 对于 $32\;\mathrm{KB}$ 直接映像混合 Cache，$F = 2.0\%$，实际 CPI 为：
$$
1.548 + 86.424 \times 2.0\% = 3.27648
$$

## 第 4 题（教材 7.13）

> 某个程序共访问存储器 $1\;000\;000$ 次，该程序在某个系统中运行，系统中 Cache 的不命中率为 $7\%$，其中，强制性不命中和容量不命中各占 $25\%$，冲突不命中占 $50\%$。问：
>
> (1) 当允许对该 Cache 所做的唯一改变是提高相联度时，此时期望能够消除的最大不命中次数是多少？
>
> (2) 当允许能够同时提高 Cache 的容量大小和相联度时，此时期望能够消除的最大不命中次数是多少？

(1) 提高相联度能减少冲突不命中率，此时期望能够消除的最大不命中次数即为冲突不命中次数，为

$$
1000000 \times 7\% \times 50\% = 35000
$$

(2) 提高 Cache 容量大小可以减少容量不命中率，提高相联度能减少冲突不命中率，此时期望能够消除的最大不命中次数即为容量不命中和冲突不命中次数之和，为

$$
1000000 \times 7\% \times (25\% + 50\%) = 52500
$$

## 第 5 题（教材 7.16）

> 设主存由 $8$ 个存储体按低位交叉编址方式组成，主存容量 $1\;\mathrm{M}$ 字，Cache 容量为 $4\;\mathrm{K}$ 字，要求一个主存周期从主存取得一个块。采用全相联地址映像，用相联目录表实现地址变换。求相联目录表的行数、比较位数、宽度和总位数。

Cache 行数等于 Cache 容量除以块大小（本题中为 $1$ 字），为 $4\;\mathrm{K} \div 1 = 4096$。

比较位数即为地址宽度，为 $\log_2(1\;\mathrm{M}) = 20$。

宽度需要加上有效位（$1$ 位），故宽度为 $20 + 1 = 21$。

总位数为 $4096 \times 21 = 86016$。
